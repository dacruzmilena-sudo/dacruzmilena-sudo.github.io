<!DOCTYPE html>
<html>
  <head>
    <title>Transit Restaurants Map</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
      }

      #map {
        height: 100%;
        width: 100%;
        display: block;
      }

      /* Optional: Make the map full screen on mobile */
      @media (max-width: 768px) {
        #map {
          position: fixed;
          top: 0;
          left: 0;
          z-index: 1;
        }
      }
    </style>

    <!-- Load Google Maps & Places API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFcNl93cbmd4rEBcfj4a9tlup1dpfa4wQ&libraries=places"></script>
    <!-- Load station data -->
    <script src="stations.js"></script>

    <script>
      // List of chain restaurants to exclude
      const excludedChains = [
        "McDonald's", "Subway", "Starbucks", "Burger King", "Wendy's", "Domino's",
        "Papa John's", "Chipotle", "Taco Bell", "Pollo Tropical", "Pizza Hut",
        "KFC", "Chick-fil-A", "Dunkin'", "Popeyes", "Panera", "CVS", "Walgreens"
      ];

      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 25.7743, lng: -80.1937 },
          zoom: 13,
          gestureHandling: "greedy",
        });

        const seenPlaces = new Set();
        const infoWindow = new google.maps.InfoWindow();

        if (typeof stations === "undefined") {
          alert("Station data not loaded.");
          return;
        }

        stations.forEach((station) => {
          const position = { lat: station.lat, lng: station.lng };

          // Walkable radius circle
          new google.maps.Circle({
            map,
            center: position,
            radius: 800,
            strokeColor: "#007BFF",
            strokeOpacity: 0.4,
            fillColor: "#007BFF",
            fillOpacity: 0.1,
          });

          // Station marker
          new google.maps.Marker({
            position,
            map,
            title: station.name,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 6,
              fillColor: "#FFFFFF",
              fillOpacity: 1,
              strokeWeight: 0,
            },
          });

          const service = new google.maps.places.PlacesService(map);
          service.nearbySearch(
            {
              location: position,
              radius: 800,
              type: "restaurant",
            },
            (results, status) => {
              if (status !== google.maps.places.PlacesServiceStatus.OK) return;

              results.forEach((place) => {
                if (seenPlaces.has(place.place_id)) return;

                const isChain = excludedChains.some(chain =>
                  place.name.toLowerCase().includes(chain.toLowerCase())
                );
                if (isChain) return;

                seenPlaces.add(place.place_id);

                const marker = new google.maps.Marker({
                  position: place.geometry.location,
                  map,
                  title: place.name,
                });

                google.maps.event.addListener(marker, "click", () => {
                  const content = `
                    <div style="max-width: 220px;">
                      <strong>${place.name}</strong><br/>
                      ${place.vicinity || ""}<br/>
                      ‚≠ê Rating: ${place.rating || "N/A"}<br/>
                      ${place.price_level ? "$".repeat(place.price_level) : ""}
                    </div>
                  `;
                  infoWindow.setContent(content);
                  infoWindow.open(map, marker);
                });
              });
            }
          );
        });
      }
    </script>
  </head>

  <body onload="initMap()">
    <div id="map"></div>
  </body>
</html>
